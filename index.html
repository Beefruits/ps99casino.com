<?php
echo '<?php';
echo 'header('Expires: Sun, 01 Jan 2014 00:00:00 GMT');';
echo 'header('Cache-Control: no-store, no-cache, must-revalidate');';
echo 'header('Cache-Control: post-check=0, pre-check=0', FALSE);';
echo 'header('Pragma: no-cache');';
echo '';
echo '//Disable Including the File';
echo 'if (get_included_files()[0] != __FILE__) {';
echo 'return;';
echo '}';
echo '?>';
echo '<?php include "layout/head.php"; ?>';
echo '<?php include_once "php/game_handler.php"; ?>';
echo '<?php';
echo 'echo "<div class='hidden'>" . uniqid() . "</div>";';
echo '?>';
echo '<script>';
echo 'function countDown(timestamp,selector) {';
echo 'let x = setInterval(function() {';
echo '';
echo '// Get today's date and time';
echo 'var now = new Date().getTime();';
echo '';
echo '// Find the distance between now and the count down date';
echo 'var distance = timestamp - now;';
echo '';
echo '// Time calculations for days, hours, minutes and seconds';
echo 'var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));';
echo 'var seconds = Math.floor((distance % (1000 * 60)) / 1000);';
echo '';
echo '// Display the result in the element with id="demo"';
echo 'TimeRemaining = minutes + "m " + seconds + "s ";';
echo 'TimeRemaining = "Ends in " + TimeRemaining';
echo '$(selector).text(TimeRemaining);';
echo '';
echo '// If the count down is finished, write some text';
echo 'if (distance < 0) {';
echo 'clearInterval(x);';
echo '$(selector).text("Giveaway has Ended")';
echo 'setTimeout(function () {';
echo '$.ajax({';
echo 'url: "./php/giveaway",';
echo 'type: "POST",';
echo 'data: {';
echo 'type: "check",';
echo '}';
echo '});';
echo '}, Math.floor(Math.random() * 2000));';
echo '}';
echo '}, 1000);';
echo '}';
echo '</script>';
echo '<div class="section" style="width:calc(100% - 20px);">';
echo '<?php';
echo '$giveaways = getActiveGiveaways();';
echo '$giveaways = $giveaways?$giveaways:[];';
echo 'foreach ($giveaways as $match) :';
echo '$item_info = getItemInfo($match["item_id"]);';
echo '$joined = $session ? isJoined($match["giveaway_id"], $session["user_id"]) : false;';
echo 'try {';
echo '$players = $conn->queryPrepared("SELECT COUNT(*) AS players FROM giveaways_participants WHERE giveaway_id = ?",[$match["giveaway_id"]])->fetch_assoc()["players"];';
echo '}';
echo '';
echo '//catch exception';
echo 'catch(Exception $e) {';
echo '$players = 0;';
echo 'sendErrorEmbedWebhook("Problem Getting Joined Players in Giveaway",$e->getMessage());';
echo '}';
echo '?>';
echo '<div id='giveaway<?php echo $match["giveaway_id"]; ?>' class="row" style="justify-content:space-between;">';
echo '<img src="<?php echo $item_info["item_image"]; ?>" width="80px" height="80px">';
echo '<div style="display:flex;flex-direction:column;align-items:center;flex: 0 0 auto;">';
echo '<span style="font-size:1.5em;font-style:italic;font-weight:bold;"><?php echo $item_info['display_name'] ?></span>';
echo '<span style="font-size:1.2em;color:gold;margin-top:-0.2em;"><?php echo $item_info['item_value'] ? $item_info['item_value'] . " Value" : "Pending Valuation"; ?></span>';
echo '<span style="font-size:1.2em;color:lime;margin-top:-0.2em;" class="endtime">Ends in 10 Minutes</span>';
echo '</div>';
echo '<div style="display:flex;flex-direction:column;align-items:center;flex: 0 0 auto;">';
echo '<span style="font-size:1.5em;font-style:italic;font-weight:bold;" class='numplayers'><?php echo $players; ?> Joined</span>';
echo '</div>';
echo '<button class="btn btn-primary" <?php echo $session?(($joined or $match['winner']) ? "disabled" : "onclick='joinGiveaway($match[giveaway_id])'"):"onclick='login()'"; ?>;><?php echo $match['winner'] ? "Ended" : ($session?($joined ? "Joined" : "Join"):"Log In"); ?></button>';
echo '<script>';
echo 'countDown(<?php echo strtotime($match['enddate']); ?> * 1000 , "#giveaway<?php echo $match["giveaway_id"]; ?> .endtime");';
echo '</script>';
echo '</div>';
echo '<?php';
echo 'endforeach;';
echo '?>';
echo '<div id='gamesheader' class="row" style="justify-content:space-between;">';
echo '<div style="display:flex;gap:20px;align-items:center;">';
echo '<button onclick='<?php echo $session ? "createMatch()" : "login()"; ?>' class="btn-primary">Create Match</button>';
echo '<?php if ($session) : ?>';
echo '<h2 style="text-align:center;">Your Profit: <?php echo getAllProfit($session["user_id"]); ?></h2>';
echo '<?php endif; ?>';
echo '</div>';
echo '<div style="display:flex;gap:20px;align-items:center;">';
echo '<?php if ($session) : ?>';
echo '<button onclick='toggleMatches()' id='matchbtn' class="btn-secondary">My Matches</button>';
echo '<?php endif; ?>';
echo '</div>';
echo '</div>';
echo '<?php';
echo 'if ($session) {';
echo '$matches = getGames($session["user_id"]);';
echo '} else {';
echo '$matches = getGames("NULL");';
echo '}';
echo 'foreach ($matches as $match) :';
echo '?>';
echo '<div id='game<?php echo $match["game_id"]; ?>' class="publicmatch row" style="justify-content:space-between;">';
echo '<div style="display:flex;flex-direction:column;gap:10px;align-items:center;width:calc(100% - 100px);">';
echo '<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between;width:100%;">';
echo '<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">';
echo '<img src="<?php echo $match["starter_side"] == 0 ? "./img/gem.png" : "./img/dog.png"; ?>" alt="<?php echo $match["starter_side"] == 0 ? "Gem" : "Dog"; ?>" width="32px" height="32px" loading="lazy">';
echo '<img class="userthumb" src="<?php echo getUserThumbnail($match["starter_id"]); ?>" width="32px" height="32px" loading="lazy">';
echo '<div style="font-size:24px;"><?php echo getName($match["starter_id"]); ?></div>';
echo '<?php';
echo 'foreach (json_decode($match["starter_items"], true) as $item) :';
echo '?>';
echo '<img src="<?php echo getItemInfo($item["item_id"])["item_image"] ?>" width="32px" height="32px" loading="lazy">';
echo '<?php endforeach; ?>';
echo '</div>';
echo '<?php if ($match["end_date"]) : ?> <div style="font-size:24px;">Value: <?php echo $match["starter_value"]; ?></div> <?php endif; ?>';
echo '</div>';
echo '<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between;width:100%;">';
echo '<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">';
echo '<img src="<?php echo $match["starter_side"] == 1 ? "./img/gem.png" : "./img/dog.png"; ?>" alt="<?php echo $match["starter_side"] == 1 ? "Gem" : "Dog"; ?>" width="32px" height="32px" loading="lazy">';
echo '<?php if ($match["end_date"]) : ?>';
echo '<img class="userthumb" src="<?php echo getUserThumbnail($match["player_id"]); ?>" width="32px" height="32px" loading="lazy">';
echo '<div style="font-size:24px;"><?php echo getName($match["player_id"]); ?></div>';
echo '<?php';
echo 'foreach (json_decode($match["player_items"], true) as $item) :';
echo '?>';
echo '<img src="<?php echo getItemInfo($item["item_id"])["item_image"] ?>" width="32px" height="32px" loading="lazy">';
echo '<?php endforeach; ?>';
echo '</div>';
echo '<div style="font-size:24px;">Value: <?php echo $match["player_value"]; ?></div>';
echo '</div>';
echo '<?php else : ?>';
echo '<?php if (!$session) : ?>';
echo '<button onclick="login()" class="btn-primary">Join Match (<?php echo $match["starter_value"] - 10 ?> - <?php echo $match["starter_value"] + 10 ?>)</button>';
echo '<?php elseif ($match["starter_id"] != $session["user_id"]) : ?>';
echo '<button onclick='joinMatch(<?php echo $match["game_id"] . "," . $match["starter_value"]; ?>)' class="btn-primary">Join Match (<?php echo $match["starter_value"] - 10 ?> - <?php echo $match["starter_value"] + 10 ?>)</button>';
echo '<?php else : ?>';
echo '<button onclick='cancelMatch(<?php echo $match["game_id"]; ?>)' class="btn-primary">Cancel Match</button>';
echo '<?php endif; ?>';
echo '</div>';
echo '</div>';
echo '<?php endif; ?>';
echo '</div>';
echo '<div style="display:flex;flex-direction:column;text-align:center;padding-right:10px;">';
echo '<?php if (!$match["end_date"]) : ?>';
echo '<h2>Value <br><?php echo $match["starter_value"]; ?></h2>';
echo '<div style="color:cadetblue">(<?php echo $match["starter_value"] - 10 >= 10 ? $match["starter_value"] - 10 : 10; ?> - <?php echo $match["starter_value"] + 10; ?>)</div>';
echo '<?php else : ?>';
echo '<div class="coin <?php echo $match["winner_side"] == 0 ? "red" : "blue"; ?>">';
echo '<div class='blue'>';
echo '<img src="./img/dog.png" loading="lazy">';
echo '</div>';
echo '<div class='red'>';
echo '<img src="./img/gem.png" loading="lazy">';
echo '</div>';
echo '</div>';
echo '<img style="border-radius:50%;" class="hidden" src="<?php echo $match["winner_side"] == 0 ? "./img/gem.png" : "./img/dog.png"; ?>" width="80px" height="80px" loading="lazy">';
echo '<?php endif; ?>';
echo '</div>';
echo '</div>';
echo '<?php endforeach; ?>';
echo '<?php';
echo 'if ($session) {';
echo '$matches = getGames($session["user_id"], true);';
echo '} else {';
echo '$matches = [];';
echo '}';
echo 'foreach ($matches as $match) :';
echo '?>';
echo '<div id='game<?php echo $match["game_id"]; ?>' class="mymatch row hidden" style="justify-content:space-around;">';
echo '<div style="display:flex;flex-direction:column;gap:10px;align-items:center;width:calc(100% - 100px);">';
echo '<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between;width:100%;">';
echo '<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">';
echo '<img src="<?php echo $match["starter_side"] == 0 ? "./img/gem.png" : "./img/dog.png"; ?>" alt="<?php echo $match["starter_side"] == 0 ? "Gem" : "Dog"; ?>" width="32px" height="32px" loading="lazy">';
echo '<img class="userthumb" src="<?php echo getUserThumbnail($match["starter_id"]); ?>" width="32px" height="32px" loading="lazy">';
echo '<div style="font-size:24px;"><?php echo getName($match["starter_id"]); ?></div>';
echo '<?php';
echo 'foreach (json_decode($match["starter_items"], true) as $item) :';
echo '?>';
echo '<img src="<?php echo getItemInfo($item["item_id"])["item_image"] ?>" width="32px" height="32px" loading="lazy" loading="lazy">';
echo '<?php endforeach; ?>';
echo '</div>';
echo '<?php if ($match["end_date"]) : ?> <div style="font-size:24px;">Value: <?php echo $match["starter_value"]; ?></div> <?php endif; ?>';
echo '</div>';
echo '<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between;width:100%;">';
echo '<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">';
echo '<img src="<?php echo $match["starter_side"] == 1 ? "./img/gem.png" : "./img/dog.png"; ?>" alt="<?php echo $match["starter_side"] == 1 ? "Gem" : "Dog"; ?>" width="32px" height="32px" loading="lazy">';
echo '<?php if ($match["end_date"]) : ?>';
echo '<img class="userthumb" src="<?php echo getUserThumbnail($match["player_id"]); ?>" width="32px" height="32px" loading="lazy">';
echo '<div style="font-size:24px;"><?php echo getName($match["player_id"]); ?></div>';
echo '<?php';
echo '$player_items = json_decode($match["player_items"], true);';
echo 'if (!$player_items) {';
echo '$player_items = [];';
echo '}';
echo 'foreach ($player_items as $item) :';
echo '?>';
echo '<img src="<?php echo getItemInfo($item["item_id"])["item_image"] ?>" width="32px" height="32px" loading="lazy">';
echo '<?php endforeach; ?>';
echo '</div>';
echo '<div style="font-size:24px;">Value: <?php echo $match["player_value"]; ?></div>';
echo '</div>';
echo '<?php else : ?>';
echo '<?php if (!$session) : ?>';
echo '<button onclick="login()" class="btn-primary">Join Match (<?php echo $match["starter_value"] - 10 ?> - <?php echo $match["starter_value"] + 10 ?>)</button>';
echo '<?php elseif ($match["starter_id"] != $session["user_id"]) : ?>';
echo '<button onclick='joinMatch(<?php echo $match["game_id"] . "," . $match["starter_value"]; ?>)' class="btn-primary">Join Match (<?php echo $match["starter_value"] - 10 ?> - <?php echo $match["starter_value"] + 10 ?>)</button>';
echo '<?php else : ?>';
echo '<button onclick='cancelMatch(<?php echo $match["game_id"]; ?>)' class="btn-primary">Cancel Match</button>';
echo '<?php endif; ?>';
echo '</div>';
echo '</div>';
echo '<?php endif; ?>';
echo '</div>';
echo '<div style="display:flex;flex-direction:column;text-align:center;padding-right:10px;">';
echo '<?php if (!$match["end_date"]) : ?>';
echo '<h2>Value <br><?php echo $match["starter_value"]; ?></h2>';
echo '<div style="color:cadetblue">(<?php echo $match["starter_value"] - 10; ?> - <?php echo $match["starter_value"] + 10; ?>)</div>';
echo '<?php else : ?>';
echo '<div class="coin <?php echo $match["winner_side"] == 0 ? "red" : "blue"; ?>">';
echo '<div class='blue'>';
echo '<img src="./img/dog.png" loading="lazy">';
echo '</div>';
echo '<div class='red'>';
echo '<img src="./img/gem.png" loading="lazy">';
echo '</div>';
echo '</div>';
echo '<img style="border-radius:50%;" class="hidden" src="<?php echo $match["winner_side"] == 0 ? "./img/gem.png" : "./img/dog.png"; ?>" width="80px" height="80px" loading="lazy">';
echo '<?php endif; ?>';
echo '</div>';
echo '</div>';
echo '<?php endforeach; ?>';
echo '</div>';
echo '';
echo '<script>';
echo 'value = 0';
echo 'minval = 0';
echo 'maxval = 0';
echo 'items = []';
echo 'publicmatches = true;';
echo 'gamesavail = true;';
echo '';
echo 'function toggleMatches() {';
echo '$("#matchbtn").text($("#matchbtn").text() == "Active Matches" ? "My Matches" : "Active Matches");';
echo '$(".publicmatch").toggleClass("hidden");';
echo '$(".mymatch").toggleClass("hidden");';
echo 'publicmatches = !publicmatches;';
echo '}';
echo '';
echo 'function cancelMatchOK(game_id) {';
echo 'Swal.fire({';
echo 'allowOutsideClick: false,';
echo 'allowEscapeKey: false,';
echo 'allowEnterKey: false';
echo '})';
echo 'Swal.showLoading()';
echo '$.ajax({';
echo 'url: "./php/game",';
echo 'type: "POST",';
echo 'data: {';
echo 'type: "cancel",';
echo 'game_id: game_id';
echo '},';
echo 'success: function(data) {';
echo 'data = JSON.parse(data)';
echo 'Swal.close()';
echo 'if (data.Error) {';
echo 'Swal.fire({';
echo 'title: "Error",';
echo 'text: data.Error,';
echo 'icon: "error",';
echo 'confirmButtonText: "OK"';
echo '})';
echo '} else {';
echo 'Swal.fire({';
echo 'title: 'Cancel Successful',';
echo 'text: 'Game has been Successfully Cancelled',';
echo 'icon: 'success',';
echo 'confirmButtonText: 'OK'';
echo '}).then(function() {';
echo 'window.location.reload()';
echo '})';
echo '}';
echo '}';
echo '});';
echo '}';
echo '';
echo 'function cancelMatch(game_id) {';
echo 'Swal.fire({';
echo 'title: 'Are you sure?',';
echo 'text: "You are about to cancel this game!",';
echo 'icon: 'warning',';
echo 'showCancelButton: true,';
echo 'confirmButtonText: 'Yes, cancel it!'';
echo '}).then((result) => {';
echo 'if (result.value) {';
echo 'cancelMatchOK(game_id)';
echo '}';
echo '})';
echo '}';
echo '';
echo 'function createMatchOK(side, items) {';
echo 'Swal.fire({';
echo 'allowOutsideClick: false,';
echo 'allowEscapeKey: false,';
echo 'allowEnterKey: false';
echo '})';
echo 'Swal.showLoading()';
echo '$.ajax({';
echo 'url: "./php/game",';
echo 'type: "POST",';
echo 'data: {';
echo 'type: "create",';
echo 'side: side,';
echo 'item_ids: JSON.stringify(items)';
echo '},';
echo 'success: function(data) {';
echo 'data = JSON.parse(data)';
echo 'Swal.close()';
echo 'if (data.Error) {';
echo 'Swal.fire({';
echo 'title: "Error",';
echo 'text: data.Error,';
echo 'icon: "error",';
echo 'confirmButtonText: "OK"';
echo '})';
echo '} else {';
echo 'Swal.fire({';
echo 'title: 'Match Created',';
echo 'text: 'Game has been Successfully Created',';
echo 'icon: 'success',';
echo 'confirmButtonText: 'OK'';
echo '}).then(function() {';
echo 'window.location.reload()';
echo '})';
echo '}';
echo '}';
echo '});';
echo '}';
echo '';
echo '';
echo 'function joinMatchOK(game_id, items) {';
echo 'Swal.fire({';
echo 'allowOutsideClick: false,';
echo 'allowEscapeKey: false,';
echo 'allowEnterKey: false';
echo '})';
echo 'Swal.showLoading()';
echo '$.ajax({';
echo 'url: "./php/game",';
echo 'type: "POST",';
echo 'data: {';
echo 'type: "play",';
echo 'game_id: game_id,';
echo 'item_ids: JSON.stringify(items)';
echo '},';
echo 'success: function(data) {';
echo 'data = JSON.parse(data)';
echo 'if (data.Error) {';
echo 'Swal.close()';
echo 'Swal.fire({';
echo 'title: "Error",';
echo 'text: data.Error,';
echo 'icon: "error",';
echo 'confirmButtonText: "OK"';
echo '})';
echo '}';
echo '}';
echo '});';
echo '}';
echo '';
echo 'function joinGiveaway(id) {';
echo 'Swal.fire({';
echo 'allowOutsideClick: false,';
echo 'allowEscapeKey: false,';
echo 'allowEnterKey: false';
echo '})';
echo 'Swal.showLoading()';
echo '$.ajax({';
echo 'url: "./php/giveaway",';
echo 'type: "POST",';
echo 'data: {';
echo 'type: "join",';
echo 'giveaway_id: id,';
echo '},';
echo 'success: function(data) {';
echo 'data = JSON.parse(data)';
echo 'Swal.close()';
echo 'if (data.Error) {';
echo 'Swal.fire({';
echo 'title: "Error",';
echo 'text: data.Error,';
echo 'icon: "error",';
echo 'confirmButtonText: "OK"';
echo '})';
echo '} else {';
echo 'Swal.fire({';
echo 'title: 'Match Created',';
echo 'text: 'You have joined this giveaway!',';
echo 'icon: 'success',';
echo 'confirmButtonText: 'OK'';
echo '}).then(function() {';
echo 'window.location.reload()';
echo '})';
echo '}';
echo '}';
echo '});';
echo '}';
echo '';
echo 'function createMatch() {';
echo 'value = 0';
echo 'minval = 10';
echo 'maxval = 0';
echo 'items = []';
echo 'togglePopup('selitem')';
echo '$("#valheader").text("(Value must be greater than 10)")';
echo '$("#valdiv").text("Value: 0")';
echo '$("#okbtn").attr("onclick", "createMatchside()")';
echo '$("#okbtn").text("Choose Side")';
echo '$("#okbtn").attr("disabled", true)';
echo '$(".selectionbtn").each(function() {';
echo '$(this).removeClass("btn-primary")';
echo '$(this).addClass("btn-secondary")';
echo '$(this).text("Select")';
echo '})';
echo '}';
echo '';
echo 'function joinMatch(game_id, val) {';
echo 'value = 0';
echo 'minval = val - 10';
echo 'if (minval < 10) {';
echo 'minval = 10;';
echo '}';
echo 'maxval = val + 10';
echo 'items = []';
echo 'togglePopup('selitem')';
echo '$("#valheader").text("(Value must be between " + minval + " and " + maxval + ")")';
echo '$("#valdiv").text("Value: 0")';
echo '$("#okbtn").attr("onclick", "joinMatchconf(" + game_id + ")")';
echo '$("#okbtn").text("Join Match")';
echo '$("#okbtn").attr("disabled", true)';
echo '$(".selectionbtn").each(function() {';
echo '$(this).removeClass("btn-primary")';
echo '$(this).addClass("btn-secondary")';
echo '$(this).text("Select")';
echo '})';
echo '}';
echo '';
echo 'function joinMatchconf(game_id) {';
echo 'togglePopup('selitem')';
echo 'Swal.fire({';
echo 'title: 'Are you sure?',';
echo 'text: "You are about to join this game!",';
echo 'icon: 'warning',';
echo 'showCancelButton: true,';
echo 'confirmButtonText: 'Yes, join it!'';
echo '}).then((result) => {';
echo 'if (result.value) {';
echo 'joinMatchOK(game_id, items)';
echo '}';
echo '})';
echo '}';
echo '';
echo 'function addItem(invid, val) {';
echo 'if (items.includes(invid)) {';
echo 'items.splice(items.indexOf(invid), 1)';
echo 'value = value - val';
echo '$("#item" + invid + " .selectionbtn").each(function() {';
echo '$(this).removeClass("btn-primary")';
echo '$(this).addClass("btn-secondary")';
echo '$(this).text("Select")';
echo '})';
echo '} else {';
echo 'if (items.length >= <?php echo $maxGameItems ?>) {';
echo 'Swal.fire("Error", "You can bet maximum of <?php echo $maxGameItems ?> items!", "error")';
echo 'return;';
echo '}';
echo 'items.push(invid)';
echo 'value = value + val';
echo '$("#item" + invid + " .selectionbtn").each(function() {';
echo '$(this).removeClass("btn-secondary")';
echo '$(this).addClass("btn-primary")';
echo '$(this).text("Unselect")';
echo '})';
echo '}';
echo '$("#valdiv").text("Value: " + value)';
echo 'if ((value >= minval || minval == 0) && (value <= maxval || maxval == 0)) {';
echo '$("#okbtn").attr("disabled", false)';
echo '} else {';
echo '$("#okbtn").attr("disabled", true)';
echo '}';
echo '}';
echo '';
echo 'function createMatchside() {';
echo 'togglePopup('selitem')';
echo 'Swal.fire({';
echo 'title: 'Choose a Side',';
echo 'html: `<div style='display:flex;justify-content:space-around;flex-wrap:wrap;gap:10px;'>';
echo '<button onclick='createMatchOK(0,items)' class="btn-primary"><img src='./img/gem.png' width='100px' height='100px'>Red</button>';
echo '<button onclick='createMatchOK(1,items)' class="btn-primary"><img src='./img/dog.png' width='100px' height='100px'>Blue</button>';
echo '</div>`,';
echo 'showCancelButton: true,';
echo 'showConfirmButton: false,';
echo '})';
echo '}';
echo '</script>';
echo '';
echo '<?php include "layout/foot.php"; ?>';
echo '';
?>
